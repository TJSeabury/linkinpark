<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linkinpark</title>
  <link rel="stylesheet" href="main.css" />
</head>

<body>
  <main>
    <header>
      <h1>Linkinpark</h1>
      <p>Crawling in my crawl.</p>
    </header>
    <section>
      <form id="crawl" action="/api/start/" method="post">
        <div>
          <input id="url" type="text" name="url" placeholder="https://horacesmithfund.org/" />
        </div>
        <div>
          <input type="submit" value="Crawl" />
        </div>
      </form>
      <div id="status">
        <p></p>
      </div>
    </section>
  </main>
  <script>
    function wait ( ms ) {
      const start = Date.now();
      let now = start;
      while ( now - start < ms ) {
        now = Date.now();
      }
    }

    const data = {
      target: ''
    };
    const crawlForm = document.querySelector( '#crawl' );

    const status = document.querySelector( '#status > p' );
    const setStatus = value => {
      status.innerHTML = value;
    };

    crawlForm.addEventListener( 'input', ev => {
      if ( ev.target.id === 'url' ) {
        data.target = ev.target.value;
        console.log( data.target );
      }
    } );

    const handleSubmit = async ev => {
      ev.preventDefault();

      const response = await fetch(
        crawlForm.getAttribute( 'action' ),
        {
          method: 'POST',
          mode: 'cors',
          cache: 'no-cache',
          credentials: 'same-origin',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify( {
            uuid: null,
            message: data.target || ''
          } )
        }
      );

      let rData = await response.json();
      const uuid = rData.uuid;

      setStatus( rData.message );

      const diff = ( () => {
        const start = Date.now();
        return () => Date.now() - start;
      } )();
      const limit = ms => diff() < ms;

      let done = false;

      while ( rData.Status !== 'done' ) {
        if ( limit( 1000 * 600 ) ) {
          const checkResponse = await fetch(
            '/api/check/',
            {
              method: 'POST',
              mode: 'cors',
              cache: 'no-cache',
              credentials: 'same-origin',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify( {
                uuid: uuid,
                message: ''
              } )
            } );

          rData = await checkResponse.json();

          setStatus( `${rData.Uuid} | ${rData.Status} | Elapsed: ${diff() / 1000} seconds | LinksFound: ${rData.LinksFound} | LinksCrawled: ${rData.LinksCrawled}` );

          if ( rData.Status === 'done' ) done = true;

          wait( 100 );

        } else {
          setStatus( `${rData.Uuid} | Timed out!! | Elapsed: ${diff() / 1000} seconds | LinksFound: ${rData.LinksFound} | LinksCrawled: ${rData.LinksCrawled}` );
          break;
        }

      }

      // go get the crawl data

    };

    crawlForm.addEventListener( 'submit', handleSubmit );

  </script>
</body>

</html>
